{% extends "base.html" %}

{% block title %}Create Daily Plan{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Create Daily Plan</h2>
    <form method="POST" id="plan-form" class="needs-validation" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="mb-3">
            <label for="plan_date" class="form-label">Plan Date</label>
            <input type="date" class="form-control" id="plan_date" name="plan_date" 
                   min="{{ today }}" required>
            <div class="invalid-feedback">Please select a valid date.</div>
        </div>

        <div id="planned-sites">
            <h4>Planned Site Visits</h4>
            <div class="planned-site mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <label for="site-select-1">Site</label>
                        <select class="site-select form-select" id="site-select-1" name="site_id[]" required>
                            <option value="">Select Site</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}" data-name="{{ site.name }}" data-location="{{ site.location }}">
                                {{ site.name }} - {{ site.location }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Planned Actions</label>
                        <textarea class="form-control" name="planned_actions[]" rows="2" required placeholder="Enter planned actions..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <label for="duration_1">Duration (minutes)</label>
                        <input type="number" name="duration[]" class="form-control" id="duration_1" min="15" max="480" value="15">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger remove-site" aria-label="Remove site">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary mb-3" id="add-site">Add Another Site</button>
        
        <div class="mt-4">
            <button type="submit" class="btn btn-primary" name="action" value="draft">Save as Draft</button>
            <button type="submit" class="btn btn-success" name="action" value="submit">Submit for Review</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize Select2 for site selection
    $('#site-select-1').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search for a site...',
        allowClear: true,
        width: '100%',
        ajax: {
            url: '/api/sites/search',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                console.log('Search params:', params); // Debug log
                return {
                    term: params.term || ''
                };
            },
            processResults: function(data) {
                console.log('Received data:', data); // Debug log
                return {
                    results: data.results,
                    pagination: data.pagination
                };
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Select2 AJAX error:', textStatus, errorThrown);
                toastr.error('Error searching sites');
            }
        },
        minimumInputLength: 2,
        templateResult: formatSite,
        templateSelection: formatSite
    });
    
    // Custom formatting for site options
    function formatSite(site) {
        if (!site.id) {
            return site.text;
        }
        console.log('Formatting site:', site); // Debug log
        return $('<div class="site-option">' +
            '<div class="site-name">' + site.text + '</div>' +
            (site.kabupaten ? '<small class="text-muted">Kabupaten: ' + site.kabupaten + '</small>' : '') +
            '</div>');
    }

    // Add site button handler
    $('#add-site').on('click', function() {
        const siteCount = $('.planned-site').length + 1;
        const newSite = `
            <div class="planned-site mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <label for="site-select-${siteCount}">Site</label>
                        <select class="site-select form-control" id="site-select-${siteCount}" name="site_id[]" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Planned Actions</label>
                        <textarea class="form-control" name="planned_actions[]" rows="2" required placeholder="Enter planned actions..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <label for="duration_${siteCount}">Duration (minutes)</label>
                        <input type="number" name="duration[]" class="form-control" id="duration_${siteCount}" min="15" max="480" value="15">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger remove-site" aria-label="Remove site">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        $('#planned-sites').append(newSite);
        // Initialize Select2 for the new select
        $(`#site-select-${siteCount}`).select2({
            theme: 'bootstrap-5',
            placeholder: 'Search for a site...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: '/api/sites/search',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        term: params.term || '',
                        page: params.page || 1
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results,
                        pagination: data.pagination
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            templateResult: formatSite,
            templateSelection: formatSite
        });
    });

    // Remove site button handler
    $(document).on('click', '.remove-site', function() {
        if ($('.planned-site').length > 1) {
            $(this).closest('.planned-site').remove();
        } else {
            toastr.warning('At least one site is required');
        }
    });
});
</script>

<style>
.site-option {
    padding: 4px;
}

.site-name {
    font-weight: 500;
}

.select2-container {
    width: 100% !important;
}

.select2-dropdown {
    z-index: 9999;
}
</style>
{% endblock %} 