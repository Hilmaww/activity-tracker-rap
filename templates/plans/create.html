{% extends "base.html" %}

{% block title %}Create Daily Plan{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Create Daily Plan</h2>
    <form method="POST" id="plan-form" class="needs-validation" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="mb-3">
            <label for="plan_date" class="form-label">Plan Date</label>
            <input type="date" class="form-control" id="plan_date" name="plan_date" 
                   min="{{ today }}" required>
            <div class="invalid-feedback">Please select a valid date.</div>
        </div>

        <div id="planned-sites">
            <h4>Planned Site Visits</h4>
            <div class="planned-site mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <label for="site-select-${siteCount}">Site</label>
                        <select class="site-select" id="site-select-${siteCount}" name="site_id[]" required>
                            <option value="">Select Site</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.site_id }} - {{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Planned Actions</label>
                        <textarea class="form-control" name="planned_actions[]" rows="2" required placeholder="Enter planned actions..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <label for="duration_${siteCount}">Duration (minutes)</label>
                        <input type="number" name="duration[]" class="form-control" id="duration_${siteCount}" min="15" max="480" value="15">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger remove-site" aria-label="Remove site">Remove Site</button>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary mb-3" id="add-site">Add Another Site</button>
        
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Save as Draft</button>
            <button type="submit" class="btn btn-success" name="submit" value="true">Submit for Review</button>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    if ($('#plan-form').length) {
        window.planManager = new PlanManager();
    }

    // Initialize Select2 for site selection
    $('.site-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search for a site...'
    });

    // Ensure the click event is bound only once
    $('#add-site').off('click').on('click', function() {
        // Clone the first planned site
        const newSite = $('.planned-site:first').clone(); // Clone the first planned site
        newSite.find('input, textarea').val(''); // Clear input values
        newSite.find('.select2').remove(); // Remove previous Select2 instance
        newSite.find('select').val(''); // Reset select value
        
        // Remove the mb-3 class from the cloned element
        newSite.removeClass('mb-3'); // Remove the mb-3 class

        // Append the new site
        $('#planned-sites').append(newSite); // Append the new site to the planned sites container
    });

    $(document).on('click', '.remove-site', function() {
        if ($('.planned-site').length > 1) {
            $(this).closest('.planned-site').remove();
        }
    });
});
</script>
{% endblock %} 