{% extends "base.html" %}

{% block title %}Edit Plan - {{ plan.plan_date.strftime('%d-%m-%Y') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Edit Plan</h2>
        <div class="btn-group">
            <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Plan
            </a>
        </div>
    </div>

    {% if plan.status.name != 'DRAFT' %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            This plan can't be edited because it's already {{ plan.status.name.lower() }}.
        </div>
    {% else %}
    <form method="POST" id="plan-form" class="needs-validation" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="plan_date" class="form-label">Plan Date</label>
                            <input type="date" class="form-control" id="plan_date" name="plan_date" 
                                   value="{{ plan.plan_date.strftime('%Y-%m-%d') }}" required>
                            <div class="invalid-feedback">Please select a valid date.</div>
                            <small class="form-text text-muted formatted-date">
                                {{ plan.plan_date.strftime('%d-%m-%Y') }}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" required>
                                {% if current_user.role == 'enom' %}
                                    <option value="DRAFT" {% if plan.status.name == 'DRAFT' %}selected{% endif %}>Draft</option>
                                    <option value="SUBMITTED" {% if plan.status.name == 'SUBMITTED' %}selected{% endif %}>Submit for Review</option>
                                {% elif current_user.role == 'tsel' %}
                                    <option value="APPROVED" {% if plan.status.name == 'APPROVED' %}selected{% endif %}>Approve</option>
                                    <option value="REJECTED" {% if plan.status.name == 'REJECTED' %}selected{% endif %}>Reject</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">Planned Sites</h4>
            </div>
            <div class="card-body">
                <div id="planned-sites">
                    {% if plan.planned_sites %}
                        {% for site in plan.planned_sites %}
                        <div class="planned-site mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="site-select-{{ loop.index }}">Site</label>
                                    <select class="site-select form-control" 
                                            id="site-select-{{ loop.index }}" 
                                            name="site_id[]" 
                                            required
                                            data-selected-id="{{ site.site.id }}"
                                            data-selected-text="{{ site.site.site_id }} - {{ site.site.name }}">
                                        <option value="{{ site.site.id }}" selected>
                                            {{ site.site.site_id }} - {{ site.site.name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Planned Actions</label>
                                    <textarea class="form-control" 
                                              name="planned_actions[]" 
                                              rows="2" 
                                              required>{{ site.planned_actions }}</textarea>
                                </div>
                                <div class="col-md-3">
                                    <label for="duration_{{ loop.index }}">Duration (minutes)</label>
                                    <input type="number" 
                                           name="duration[]" 
                                           class="form-control" 
                                           id="duration_{{ loop.index }}" 
                                           min="15" 
                                           max="480" 
                                           value="{{ site.estimated_duration }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-danger remove-site">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="planned-site mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="site-select-1">Site</label>
                                    <select class="site-select form-select" 
                                            id="site-select-1" 
                                            name="site_id[]" 
                                            required>
                                        <option value="">Select Site</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Planned Actions</label>
                                    <textarea class="form-control" 
                                              name="planned_actions[]" 
                                              rows="2" 
                                              required 
                                              placeholder="Enter planned actions..."></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label for="duration_1">Duration (minutes)</label>
                                    <input type="number" 
                                           name="duration[]" 
                                           class="form-control" 
                                           id="duration_1" 
                                           min="15" 
                                           max="480" 
                                           value="15">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-danger remove-site">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <button type="button" class="btn btn-secondary" id="add-site">
                    <i class="fas fa-plus"></i> Add Site
                </button>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary" name="action" value="save">
                <i class="fas fa-save"></i> Save Changes
            </button>
            {% if current_user.role == 'enom' %}
            <button type="submit" class="btn btn-success" name="action" value="submit">
                <i class="fas fa-paper-plane"></i> Submit for Review
            </button>
            {% endif %}
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize Select2 for all site selects
    function initializeSelect2(element = '#site-select-1') {
        $(element).each(function() {
            const $select = $(this);
            
            $select.select2({
                theme: 'bootstrap-5',
                placeholder: 'Search for a site...',
                allowClear: true,
                width: '100%',
                ajax: {
                    url: '/api/sites/search',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term || '',
                            page: params.page || 1,
                            limit: 10
                        };
                    },
                    processResults: function(data, params) {
                        console.log('Received data:', data);
                        params.page = params.page || 1;
                        
                        return {
                            results: data.results.map(site => ({
                                id: site.id,
                                text: `${site.site_id} - ${site.name}`,
                                site_id: site.site_id,
                                name: site.name,
                                kabupaten: site.kabupaten
                            })),
                            pagination: {
                                more: (params.page * 10) < data.total_count
                            }
                        };
                    },
                    cache: true,
                    error: function (xhr, status, error) {
                        console.error('Select2 AJAX error:', status, error);
                        console.log('Response:', xhr.responseText);
                        toastr.error('Failed to load sites. Please try again.');
                    }
                },
                minimumInputLength: 2,
                templateResult: formatSiteResult,
                templateSelection: formatSiteSelection
            }).on('select2:open', function() {
                console.log('Select2 opened');
            }).on('select2:closing', function() {
                console.log('Select2 closing');
            });
        });
    }
    initializeSelect2();

    function formatSiteResult(site) {
        if (!site.id) return site.text;
        return $(`
            <div class="site-result">
                <div class="site-name">${site.site_id} - ${site.name}</div>
                <small class="text-muted">
                    <i class="fas fa-map-marker-alt"></i> ${site.kabupaten}
                </small>
            </div>
        `);
    }

    function formatSiteSelection(site) {
        return site.id ? `${site.site_id} - ${site.name}` : site.text;
    }

    // Format date input to dd-mm-yyyy
    function formatDate(date) {
        return date.split('-').reverse().join('-');
    }

    $('#plan_date').on('change', function() {
        const formattedDate = formatDate($(this).val());
        $('.formatted-date').text(formattedDate);
    });

    // Add site button handler
    $('#add-site').on('click', function() {
        const siteCount = $('.planned-site').length + 1;
        const newSite = `
            <div class="planned-site mb-4">
                <div class="row">
                    <div class="col-md-4">
                        <label for="site-select-${siteCount}">Site</label>
                        <select class="site-select form-control" id="site-select-${siteCount}" name="site_id[]" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Planned Actions</label>
                        <textarea class="form-control" name="planned_actions[]" rows="2" required placeholder="Enter planned actions..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <label for="duration_${siteCount}">Duration (minutes)</label>
                        <input type="number" name="duration[]" class="form-control" id="duration_${siteCount}" min="15" max="480" value="15">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger remove-site">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        $('#planned-sites').append(newSite);
        
        // Initialize Select2 for the new select
        const $newSelect = $(`#site-select-${siteCount}`);
        initializeSelect2($newSelect);
    });

    // Remove site button handler
    $(document).on('click', '.remove-site', function() {
        if ($('.planned-site').length > 1) {
            $(this).closest('.planned-site').remove();
        } else {
            toastr.warning('At least one site is required');
        }
    });

    // Form validation
    $('#plan-form').on('submit', function(e) {
        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        $(this).addClass('was-validated');
    });
});
</script>

<style>
.site-result {
    padding: 8px;
}

.site-name {
    font-weight: 500;
}

.select2-container {
    width: 100% !important;
}

.planned-site {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.formatted-date {
    display: block;
    margin-top: 5px;
}

/* Add these Select2 specific styles */
.select2-container--bootstrap-5 .select2-dropdown {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #fff;
}

.select2-results {
    display: block;
}

.select2-container--bootstrap-5 .select2-results__options {
    max-height: 200px;
    overflow-y: auto;
    padding: 0.5rem 0;
}

.select2-search__field {
    width: 100% !important;
    padding: 0.375rem 0.75rem;
}
</style>
{% endblock %} 