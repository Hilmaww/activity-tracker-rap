{% extends "base.html" %}

{% block content %}
    <!-- Dashboard Overview -->
    <div class="row ticket-stats">
        <div class="col-md-3">
            <div class="card text-center clickable" data-status="OPEN">
                <div class="card-body">
                    <h5 class="card-title">Open Tickets</h5>
                    <p class="card-text h3">{{ open_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center clickable" data-status="IN_PROGRESS">
                <div class="card-body">
                    <h5 class="card-title">In Progress</h5>
                    <p class="card-text h3">{{ in_progress_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center clickable" data-status="PENDING">
                <div class="card-body">
                    <h5 class="card-title">Pending</h5>
                    <p class="card-text h3">{{ pending_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center clickable" data-status="RESOLVED">
                <div class="card-body">
                    <h5 class="card-title">Resolved</h5>
                    <p class="card-text h3">{{ resolved_tickets }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="text-center mb-4">Ticket Status Distribution</h4>
                <div class="chart-wrapper">
                    <canvas id="statusPieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h4 class="text-center mb-4">Tickets Trend (Last 7 Days)</h4>
                <div class="chart-wrapper">
                    <canvas id="trendLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="/tickets/new" class="btn btn-primary">Create New Ticket</a>
        <a href="/tickets" class="btn btn-secondary">View All Tickets</a>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelectorAll('.clickable').forEach(card => {
        card.addEventListener('click', function() {
            const status = this.dataset.status;
            window.location.href = "{{ url_for('main.list_tickets') }}?status=" + status;
        });
    });

    // Chart configurations
    const statusPieChart = new Chart(
        document.getElementById('statusPieChart'),
        {
            type: 'doughnut',
            data: {
                labels: ['Open', 'In Progress', 'Pending', 'Resolved'],
                datasets: [{
                    data: [
                        {{ open_tickets }},
                        {{ in_progress_tickets }},
                        {{ pending_tickets }},
                        {{ resolved_tickets }}
                    ],
                    backgroundColor: [
                        '#ff6384',
                        '#36a2eb',
                        '#ffce56',
                        '#4bc0c0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        }
    );

    // Assuming you pass trend_data from your Flask route
    const trendLineChart = new Chart(
        document.getElementById('trendLineChart'),
        {
            type: 'line',
            data: {
                labels: {{ trend_labels | tojson }},
                datasets: [{
                    label: 'New Tickets',
                    data: {{ trend_data | tojson }},
                    borderColor: '#36a2eb',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        }
    );
</script>
{% endblock %}

